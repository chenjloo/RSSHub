name: Sync RSSHub upstream â†’ master

on:
  schedule:
    - cron: '0 3 * * *'   # Run once daily (UTC)
  workflow_dispatch:
    inputs:
      confirm:
        description: 'This workflow only runs on master branch'
        required: false

jobs:
  sync:
    # Safety check: only allow this job to run on master branch
    if: github.ref == 'refs/heads/master'

    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      # Always checkout master branch explicitly
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      # Configure git identity for GitHub Actions
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # Add official RSSHub upstream repository and fetch updates
      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/DIYgod/RSSHub.git
          git fetch upstream

      # Try to merge upstream/master into local master
      - name: Merge upstream into master
        id: merge
        run: |
          git merge upstream/master --no-ff --no-edit
        continue-on-error: true

      # Push changes only if merge succeeds without conflicts
      - name: Push if merge succeeded
        if: steps.merge.outcome == 'success'
        run: |
          git push origin master

      # Create an issue if merge fails due to conflicts
      - name: Create issue on conflict
        if: steps.merge.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Upstream sync conflict on master',
              body: `
### âŒ Upstream sync failed (Conflict detected)

Merging upstream RSSHub changes into **master** branch resulted in **merge conflicts**.
This sync process has been **automatically stopped**.

- Upstream branch: \`upstream/master\`
- Target branch: \`master\`
- GitHub Actions log: ${runUrl}

Please resolve the conflicts manually before the next sync.

---

### âŒ ä¸Šæ¸¸åŒæ­¥å¤±è´¥ï¼ˆæ£€æµ‹åˆ°å†²çªï¼‰

åœ¨å°†ä¸Šæ¸¸ RSSHub çš„æ›´æ–°åˆå¹¶åˆ° **master** åˆ†æ”¯æ—¶å‘ç”Ÿ **ä»£ç å†²çª**ï¼Œ
åŒæ­¥æµç¨‹å·² **è‡ªåŠ¨ä¸­æ­¢**ã€‚

- ä¸Šæ¸¸åˆ†æ”¯ï¼š\`upstream/master\`
- å½“å‰åˆ†æ”¯ï¼š\`master\`
- Actions æ—¥å¿—ï¼š${runUrl}

è¯·äººå·¥å¤„ç†å†²çªï¼ˆè§£å†³ / revert / å¿½ç•¥ç›¸å…³æäº¤ï¼‰åå†ç»§ç»­åŒæ­¥ã€‚
`
            });
